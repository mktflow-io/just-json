name: Release

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: arc-runner-set
    container:
      image: ghcr.io/sas-daftech/kraken/ci:latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: version
        shell: bash
        run: |
          RAW_VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          CURRENT_VERSION=${RAW_VERSION%-SNAPSHOT}
          echo "Current pom.xml version: $RAW_VERSION (base: $CURRENT_VERSION)"

          MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)

          LATEST_TAG=$(git tag -l 'v[0-9]*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            COMMIT_RANGE="HEAD"
          else
            COMMIT_RANGE="${LATEST_TAG}..HEAD"
          fi

          BUMP="patch"
          while IFS= read -r message; do
            if echo "$message" | grep -qiE '^[a-z]+(\(.+\))?!:|BREAKING CHANGE'; then
              BUMP="major"
              break
            fi
            if echo "$message" | grep -qE '^feat(\(.+\))?:'; then
              if [ "$BUMP" != "major" ]; then
                BUMP="minor"
              fi
            fi
          done < <(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges 2>/dev/null || git log HEAD --pretty=format:"%s" --no-merges -1)

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Bump type: $BUMP"
          echo "New version: $NEW_VERSION"

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set version in pom.xml
        run: mvn versions:set -DnewVersion=${{ steps.version.outputs.new_version }} -DgenerateBackupPoms=false -q

      - name: Build and test
        run: mvn clean package -q

      - name: Generate release notes
        id: notes
        shell: bash
        run: |
          LATEST_TAG=$(git tag -l 'v[0-9]*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            COMMIT_RANGE="HEAD"
          else
            COMMIT_RANGE="${LATEST_TAG}..HEAD"
          fi

          {
            echo "notes<<EOF"
            echo "## What's Changed"
            echo ""
            git log "$COMMIT_RANGE" --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || git log HEAD --pretty=format:"- %s (%h)" --no-merges -1
            echo ""
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LATEST_TAG:-v0.0.0}...v${{ steps.version.outputs.new_version }}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        run: |
          git add pom.xml just-json-core/pom.xml just-json-processor/pom.xml just-json-tests/pom.xml
          git commit -m "chore(release): v${{ steps.version.outputs.new_version }}"

      - name: Create tag
        run: git tag "v${{ steps.version.outputs.new_version }}"

      - name: Push release commit and tag
        run: |
          git push origin main
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: Prepare next development version
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.new_version }}-SNAPSHOT -DgenerateBackupPoms=false -q
          git add pom.xml just-json-core/pom.xml just-json-processor/pom.xml just-json-tests/pom.xml
          git commit -m "chore: prepare next development version (${{ steps.version.outputs.new_version }}-SNAPSHOT)"
          git push origin main

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.new_version }}" \
            just-json-core/target/just-json-core-${{ steps.version.outputs.new_version }}.jar \
            just-json-core/target/just-json-core-${{ steps.version.outputs.new_version }}-sources.jar \
            just-json-processor/target/just-json-processor-${{ steps.version.outputs.new_version }}.jar \
            just-json-processor/target/just-json-processor-${{ steps.version.outputs.new_version }}-sources.jar \
            --title "v${{ steps.version.outputs.new_version }}" \
            --notes "${{ steps.notes.outputs.notes }}"
